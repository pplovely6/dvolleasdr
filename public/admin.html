<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dardilly Admin</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg: #0f0f0f;
            --panel: #1a1d24;
            --brand: #fce300;
            --text: #fff;
            --sub: #aaa;
            --border: #333;
        }

        body {
            font-family: 'Outfit', sans-serif;
            background: var(--bg);
            color: var(--text);
            margin: 0;
            display: flex;
            height: 100vh;
            overflow: hidden;
        }

        .sidebar {
            width: 260px;
            background: var(--panel);
            border-right: 1px solid var(--border);
            display: flex;
            flex-direction: column;
            padding-top: 25px;
        }

        .brand {
            padding: 0 30px 40px;
            color: var(--brand);
            font-weight: 800;
            font-size: 1.4rem;
            text-transform: uppercase;
        }

        .nav-item {
            padding: 16px 30px;
            cursor: pointer;
            color: var(--sub);
            font-weight: 500;
            display: flex;
            gap: 15px;
            transition: 0.2s;
        }

        .nav-item:hover,
        .nav-item.active {
            background: #2a2d35;
            color: white;
            border-left: 4px solid var(--brand);
        }

        .main {
            flex: 1;
            padding: 40px;
            overflow-y: auto;
        }

        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        h1 {
            margin: 0;
            font-size: 2rem;
            font-weight: 700;
        }

        .controls {
            background: var(--panel);
            padding: 25px;
            border-radius: 12px;
            border: 1px solid var(--border);
            margin-bottom: 30px;
            display: flex;
            gap: 20px;
            align-items: center;
        }

        label {
            text-transform: uppercase;
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--sub);
            display: block;
            margin-bottom: 8px;
        }

        select {
            width: 100%;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
        }

        .btn {
            padding: 12px 24px;
            background: var(--brand);
            color: black;
            border: none;
            border-radius: 6px;
            font-weight: 700;
            cursor: pointer;
            text-transform: uppercase;
        }

        .btn-icon {
            width: 45px;
            display: flex;
            justify-content: center;
        }

        .grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 25px;
        }

        .card {
            background: var(--panel);
            border: 1px solid var(--border);
            border-radius: 12px;
            padding: 20px;
            transition: 0.2s;
        }

        .card:hover {
            transform: translateY(-3px);
            border-color: #555;
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
        }

        .badge {
            background: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 0.85rem;
            color: var(--brand);
            font-weight: 700;
        }

        .actions {
            margin-top: 15px;
            padding-top: 15px;
            border-top: 1px solid var(--border);
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        .icon-action {
            width: 35px;
            height: 35px;
            background: #252525;
            border-radius: 6px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
        }

        .icon-action:hover {
            background: white;
            color: black;
        }

        .icon-action.del:hover {
            background: #ff4e45;
            color: white;
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.9);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal-box {
            background: var(--panel);
            width: 500px;
            padding: 40px;
            border-radius: 16px;
            border: 1px solid var(--border);
        }

        .form-row {
            display: flex;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        input,
        select {
            width: 100%;
            padding: 12px;
            background: #0f0f0f;
            border: 1px solid var(--border);
            color: white;
            border-radius: 6px;
            box-sizing: border-box;
        }

        .section {
            display: none;
        }

        .section.active {
            display: block;
        }
    </style>
</head>

<body>

    <aside class="sidebar">
        <div class="brand"><i class="fa-solid fa-volleyball"></i> ADMIN PANEL</div>
        <div class="nav-item active" onclick="switchTab('planning')"><i class="fa-solid fa-calendar-days"></i> Planning
        </div>
        <div class="nav-item" onclick="switchTab('matches')"><i class="fa-solid fa-trophy"></i> Résultats</div>
        <div class="nav-item" onclick="switchTab('players')"><i class="fa-solid fa-users"></i> Joueurs</div>
        <div class="nav-item" style="margin-top:auto; border-top:1px solid #333"
            onclick="window.location.href='index.html'"><i class="fa-solid fa-arrow-up-right-from-square"></i> Voir le
            Site</div>
    </aside>

    <main class="main">

        <section id="sec-planning" class="section active">
            <div class="header">
                <h1>Matchs à Venir</h1> <button class="btn" onclick="editPlan()">+ Ajouter</button>
            </div>
            <div class="controls">
                <div style="flex:1">
                    <label>Sélectionner l'équipe</label>
                    <select id="plan-db" onchange="loadPlanning()">
                        <option value="schedule-dep-garcons">DEP Garçons</option>
                        <option value="schedule-m18-garcons">M18 Garçons</option>
                        <option value="schedule-m18-filles-1">M18 Filles 1</option>
                        <option value="schedule-m18-filles-2">M18 Filles 2</option>
                        <option value="schedule-senior-filles-1">Senior Filles 1</option>
                        <option value="schedule-senior-filles-2">Senior Filles 2</option>
                        <option value="schedule-m15-filles">M15 Filles</option>
                        <option value="schedule-m13-mixte">M13 Mixte</option>
                    </select>
                </div>
                <button class="btn btn-icon" onclick="loadPlanning()"><i class="fa-solid fa-rotate"></i></button>
            </div>
            <div id="grid-planning" class="grid"></div>
        </section>

        <section id="sec-matches" class="section">
            <div class="header">
                <h1>Résultats Passés</h1> <button class="btn" onclick="editMatch()">+ Ajouter</button>
            </div>
            <div class="controls">
                <div style="flex:1">
                    <label>Sélectionner l'équipe</label>
                    <select id="match-db" onchange="loadMatches()">
                        <option value="matches-dep-garcons">DEP Garçons</option>
                        <option value="matches-db">M18 Garçons</option>
                        <option value="matches-m18-filles-1">M18 Filles 1</option>
                        <option value="matches-m18-filles-2">M18 Filles 2</option>
                        <option value="matches-senior-filles-1">Senior Filles 1</option>
                        <option value="matches-senior-filles-2">Senior Filles 2</option>
                        <option value="matches-m15-filles">M15 Filles</option>
                        <option value="matches-m13-mixte">M13 Mixte</option>
                    </select>
                </div>
                <button class="btn btn-icon" onclick="loadMatches()"><i class="fa-solid fa-rotate"></i></button>
            </div>
            <div id="grid-matches" class="grid"></div>
        </section>

        <section id="sec-players" class="section">
            <div class="header">
                <h1>Effectif Joueurs</h1> <button class="btn" onclick="editPlayer()">+ Ajouter</button>
            </div>
            <div class="controls">
                <div style="flex:1">
                    <label>Sélectionner l'équipe</label>
                    <select id="player-db" onchange="loadPlayers()">
                        <option value="db-dep-garcons">DEP Garçons</option>
                        <option value="db-m18-garcons">M18 Garçons</option>
                        <option value="db-m18-filles-1">M18 Filles 1</option>
                        <option value="db-m18-filles-2">M18 Filles 2</option>
                        <option value="db-senior-filles-1">Senior Filles 1</option>
                        <option value="db-senior-filles-2">Senior Filles 2</option>
                        <option value="db-m15-filles">M15 Filles</option>
                        <option value="db-m13-mixte">M13 Mixte</option>
                    </select>
                </div>
                <button class="btn btn-icon" onclick="loadPlayers()"><i class="fa-solid fa-rotate"></i></button>
            </div>
            <div id="grid-players" class="grid"></div>
        </section>

    </main>

    <div id="modal-plan" class="modal">
        <div class="modal-box">
            <h2>Programmer un Match</h2>
            <input type="hidden" id="pl-id">
            <div class="form-row">
                <div style="flex:1"><label>Date (ex: 10 JAN)</label><input type="text" id="pl-date"></div>
                <div style="flex:1"><label>Heure (ex: 20:30)</label><input type="text" id="pl-time"></div>
            </div>
            <div class="form-row">
                <div style="flex:1"><label>Domicile</label><input type="text" id="pl-home" value="AS DARDILLY"></div>
                <div style="flex:1"><label>Extérieur</label><input type="text" id="pl-away"></div>
            </div>
            <div class="form-group"><label>Lieu</label><input type="text" id="pl-loc" value="Gymnase Roland Guillaud">
            </div>
            <div class="form-row" style="margin-top:30px">
                <button class="btn" style="flex:2" onclick="savePlan()">Enregistrer</button>
                <button class="btn" style="flex:1; background:#333;" onclick="closeModals()">Annuler</button>
            </div>
        </div>
    </div>


    <div id="modal-match" class="modal">
        <div class="modal-box">
            <h2>Résultat de Match</h2>
            <input type="hidden" id="mt-id">
            <div class="form-row">
                <div style="flex:1"><label>Domicile</label><input type="text" id="mt-home" value="AS DARDILLY"></div>
                <div style="flex:1"><label>Extérieur</label><input type="text" id="mt-away"></div>
            </div>
            <div class="form-row">
                <div style="flex:1"><label>Score (ex: 3 - 0)</label><input type="text" id="mt-score"></div>
                <div style="flex:1"><label>Date</label><input type="text" id="mt-date"></div>
            </div>
            <div class="form-group"><label>Sets (ex: 25:20, 25:15...)</label><input type="text" id="mt-sets"></div>

            <div class="form-group" style="border-top: 1px solid #333; padding-top: 20px; text-align: center;">
                <p style="color: #aaa; margin-bottom: 10px;">Options Avancées (Stats, Compo)</p>
                <button class="btn" style="background: #333; width: 100%; border: 1px solid #555;"
                    onclick="switchToAdvancedDetail()">
                    <i class="fa-solid fa-chart-simple"></i> Gérer les Détails du Match
                </button>
            </div>

            <div class="form-row" style="margin-top:30px">
                <button class="btn" style="flex:2" onclick="saveMatch()">Enregistrer Rapide</button>
                <button class="btn" style="flex:1; background:#333;" onclick="closeModals()">Annuler</button>
            </div>
        </div>
    </div>

    <!-- NEW ADVANCED DETAIL MODAL -->
    <div id="modal-match-detail" class="modal" style="display:none; overflow-y: auto;">
        <div class="modal-box" style="width: 800px; max-height: 90vh; overflow-y: auto;">
            <div class="header" style="margin-bottom: 20px;">
                <h2 id="adv-title">Match Détails</h2>
                <button class="btn btn-icon" onclick="closeModals()" style="background: #333;"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>

            <input type="hidden" id="adv-id">

            <!-- 1. SCORE & SETS -->
            <div class="controls" style="display:block; margin-bottom: 20px;">
                <h4 style="margin-top:0">Score & Sets</h4>
                <div style="display:flex; gap:20px;">
                    <div><label>Score</label><input type="text" id="adv-score"></div>
                    <div style="flex:1"><label>Détail Sets</label><input type="text" id="adv-sets"></div>
                </div>
            </div>

            <!-- 2. LINEUP -->
            <div class="controls" style="display:block; margin-bottom: 20px;">
                <h4 style="margin-top:0">6 de Départ (Position)</h4>
                <p style="font-size: 0.8rem; color: #aaa;">Indiquez les noms ou numéros des joueurs titulaires.</p>
                <div style="display:grid; grid-template-columns: repeat(3, 1fr); gap:10px;">
                    <input type="text" id="adv-p4" placeholder="Pos 4 (Av-G)">
                    <input type="text" id="adv-p3" placeholder="Pos 3 (Av-C)">
                    <input type="text" id="adv-p2" placeholder="Pos 2 (Av-D)">
                    <input type="text" id="adv-p5" placeholder="Pos 5 (Ar-G)">
                    <input type="text" id="adv-p6" placeholder="Pos 6 (Ar-C)">
                    <input type="text" id="adv-p1" placeholder="Pos 1 (Ar-D)">
                </div>
                <div style="margin-top:10px;">
                    <input type="text" id="adv-libero" placeholder="Libéro">
                </div>
            </div>

            <!-- 2.5 ROSTERS (EFFECTIFS) -->
            <div class="controls" style="display:block; margin-bottom: 20px;">
                <h4 style="margin-top:0">Effectifs (Composition)</h4>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:30px;">

                    <!-- HOME ROSTER -->
                    <div style="background:#1a1d24; padding:15px; border-radius:8px; border:1px solid #333;">
                        <h5 style="margin:0 0 10px 0; color:#aaa;">DOMICILE (Depuis Base)</h5>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <select id="adv-roster-home-select" style="padding:8px;">
                                <option value="">Choisir joueur...</option>
                            </select>
                            <button class="btn" style="padding:8px 12px;" onclick="addHomeRoster()"><i
                                    class="fa-solid fa-plus"></i></button>
                        </div>
                        <ul id="list-roster-home"
                            style="list-style:none; padding:0; margin:0; max-height:200px; overflow-y:auto;">
                            <!-- Items -->
                        </ul>
                    </div>

                    <!-- AWAY ROSTER -->
                    <div style="background:#1a1d24; padding:15px; border-radius:8px; border:1px solid #333;">
                        <h5 style="margin:0 0 10px 0; color:#aaa;">EXTÉRIEUR (Manuel)</h5>
                        <div style="display:flex; gap:10px; margin-bottom:10px;">
                            <input type="number" id="adv-away-num" placeholder="#" style="width:50px; padding:8px;">
                            <input type="text" id="adv-away-name" placeholder="Nom" style="flex:1; padding:8px;">
                            <button class="btn" style="padding:8px 12px;" onclick="addAwayRoster()"><i
                                    class="fa-solid fa-plus"></i></button>
                        </div>
                        <ul id="list-roster-away"
                            style="list-style:none; padding:0; margin:0; max-height:200px; overflow-y:auto;">
                            <!-- Items -->
                        </ul>
                    </div>

                </div>
            </div>

            <!-- 3. PLAYER STATS -->
            <div class="controls" style="display:block;">
                <h4 style="margin-top:0">Statistiques Joueurs</h4>

                <div style="display: flex; gap: 10px; margin-bottom: 15px; align-items: flex-end;">
                    <div style="flex:1;">
                        <label>Ajouter un joueur (depuis liste)</label>
                        <select id="adv-player-select">
                            <option value="">-- Sélectionner --</option>
                        </select>
                    </div>
                    <button class="btn" onclick="addPlayerToStats()"><i class="fa-solid fa-plus"></i></button>
                </div>

                <div style="max-height: 300px; overflow-y: auto;">
                    <table class="vw-table" style="width:100%; text-align: left; border-collapse: collapse;">
                        <thead style="background: #222; position: sticky; top: 0;">
                            <tr>
                                <th style="padding:10px;">#</th>
                                <th>Nom</th>
                                <th>Pts</th>
                                <th>Att</th>
                                <th>Blk</th>
                                <th>Ace</th>
                                <th></th>
                            </tr>
                        </thead>
                        <tbody id="adv-stats-body"></tbody>
                    </table>
                </div>
            </div>

            <div class="form-row" style="margin-top:30px">
                <button class="btn" style="flex:2" onclick="saveAdvancedDetails()">Enregistrer Tout</button>
                <button class="btn" style="flex:1; background:#333;" onclick="closeModals()">Fermer</button>
            </div>
        </div>
    </div>

    <div id="modal-player" class="modal" style="overflow-y: auto;">
        <div class="modal-box" style="width: 700px; max-height: 90vh; overflow-y: auto;">
            <h2>Fiche Joueur</h2>
            <div class="form-row">
                <div style="width:80px"><label>N°</label><input type="number" id="py-number"></div>
                <div style="flex:1"><label>Nom Complet</label><input type="text" id="py-name"></div>
                <div style="flex:1">
                    <label>Poste</label>
                    <select id="py-pos">
                        <option value="S">S (Passeur)</option>
                        <option value="OH">OH (Récep/Attaq)</option>
                        <option value="MB">MB (Central)</option>
                        <option value="OP">OP (Pointu)</option>
                        <option value="L">L (Libero)</option>
                    </select>
                </div>
            </div>

            <div class="form-row">
                <div style="flex:1"><label>Nationalité</label><input type="text" id="py-nat" placeholder="ex: France">
                </div>
                <div style="flex:1"><label>Age</label><input type="number" id="py-age"></div>
                <div style="flex:1"><label>Date Naissance</label><input type="text" id="py-dob"
                        placeholder="JJ/MM/AAAA"></div>
                <div style="flex:1"><label>Taille</label><input type="text" id="py-height" placeholder="ex: 185 cm">
                </div>
            </div>

            <div style="border-top: 1px solid #333; margin: 20px 0; padding-top: 20px;">
                <h3 style="margin-top:0">Statistiques de Saison</h3>
                <div class="form-row">
                    <div style="flex:1"><label>Total Points</label><input type="number" id="st-total"></div>
                    <div style="flex:1"><label>Moyenne /Match</label><input type="text" id="st-avg-m"></div>
                </div>

                <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--brand);">ATTAQUE</h4>
                    <div class="form-row" style="margin-bottom:0">
                        <div style="flex:1"><label>Points</label><input type="number" id="st-att-pts"></div>
                        <div style="flex:1"><label>Efficacité (%)</label><input type="text" id="st-att-eff"></div>
                        <div style="flex:1"><label>Moyenne</label><input type="text" id="st-att-avg"></div>
                    </div>
                </div>

                <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:8px; margin-bottom:15px;">
                    <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--brand);">BLOCK</h4>
                    <div class="form-row" style="margin-bottom:0">
                        <div style="flex:1"><label>Points</label><input type="number" id="st-blk-pts"></div>
                        <div style="flex:1"><label>Succès (%)</label><input type="text" id="st-blk-succ"></div>
                        <div style="flex:1"><label>Moyenne</label><input type="text" id="st-blk-avg"></div>
                    </div>
                </div>

                <div style="background:rgba(255,255,255,0.03); padding:15px; border-radius:8px;">
                    <h4 style="margin:0 0 10px 0; font-size:0.9rem; color:var(--brand);">SERVICE</h4>
                    <div class="form-row" style="margin-bottom:0">
                        <div style="flex:1"><label>Points</label><input type="number" id="st-srv-pts"></div>
                        <div style="flex:1"><label>Succès (%)</label><input type="text" id="st-srv-succ"></div>
                        <div style="flex:1"><label>Moyenne</label><input type="text" id="st-srv-avg"></div>
                    </div>
                </div>
            </div>

            <div class="form-group"><label>Lien Profil / Photo</label><input type="text" id="py-profile"></div>
            <div class="form-group"><label style="display:flex;align-items:center;gap:10px"><input type="checkbox"
                        id="py-captain" style="width:auto"> Capitaine de l'équipe</label></div>

            <div class="form-row" style="margin-top:30px">
                <button class="btn" style="flex:2" onclick="savePlayer()">Enregistrer Joueur</button>
                <button class="btn" style="flex:1; background:#333;" onclick="closeModals()">Annuler</button>
            </div>
        </div>
    </div>


    <script>
        const API_BASE = '/api';

        // --- TABS & NAVIGATION ---
        function switchTab(tab) {
            document.querySelectorAll('.section').forEach(el => el.classList.remove('active'));
            document.getElementById(`sec-${tab}`).classList.add('active');

            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            const navs = document.querySelectorAll('.nav-item');
            // Mapping based on index
            if (tab === 'planning') navs[0].classList.add('active');
            if (tab === 'matches') navs[1].classList.add('active');
            if (tab === 'players') navs[2].classList.add('active');

            if (tab === 'planning') loadPlanning();
            if (tab === 'matches') loadMatches();
            if (tab === 'players') loadPlayers();
        }

        function closeModals() {
            document.querySelectorAll('.modal').forEach(m => m.style.display = 'none');
        }

        // --- HELPER: DELETE ---
        async function deleteItem(file, id) {
            if (!confirm("Supprimer ?")) return;
            await fetch(`${API_BASE}/delete/${file}/${id}`, { method: 'DELETE' });
            if (file.includes('schedule')) loadPlanning();
            else if (file.includes('matches')) loadMatches();
            else if (file.includes('db-')) loadPlayers();
        }

        // --- PLANNING ---
        async function loadPlanning() {
            const db = document.getElementById('plan-db').value;
            try {
                const res = await fetch(`${API_BASE}/data/${db}`);
                const data = await res.json();
                renderPlanning(data.schedule || [], db);
            } catch (e) { console.error(e); }
        }

        function renderPlanning(list, db) {
            const grid = document.getElementById('grid-planning');
            grid.innerHTML = '';
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-header">
                        <span class="badge">${item.date}</span>
                        <span style="font-size:0.9rem; color:#aaa">${item.time}</span>
                    </div>
                    <h3>${item.home} vs ${item.away}</h3>
                    <p style="color:#aaa; font-size:0.9rem">${item.location}</p>
                    <div class="actions">
                        <div class="icon-action" onclick='editPlan(${JSON.stringify(item)})'><i class="fa-solid fa-pen"></i></div>
                        <div class="icon-action del" onclick="deleteItem('${db}', '${item.id}')"><i class="fa-solid fa-trash"></i></div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function editPlan(item = null) {
            document.getElementById('modal-plan').style.display = 'flex';
            if (item) {
                document.getElementById('pl-id').value = item.id;
                document.getElementById('pl-date').value = item.date;
                document.getElementById('pl-time').value = item.time;
                document.getElementById('pl-home').value = item.home;
                document.getElementById('pl-away').value = item.away;
                document.getElementById('pl-loc').value = item.location;
            } else {
                document.getElementById('pl-id').value = Date.now().toString();
                document.getElementById('pl-date').value = '';
                document.getElementById('pl-time').value = '';
                document.getElementById('pl-home').value = 'AS DARDILLY';
                document.getElementById('pl-away').value = '';
                document.getElementById('pl-loc').value = 'Gymnase Roland Guillaud';
            }
        }

        async function savePlan() {
            const db = document.getElementById('plan-db').value;
            const plan = {
                id: document.getElementById('pl-id').value,
                date: document.getElementById('pl-date').value,
                time: document.getElementById('pl-time').value,
                home: document.getElementById('pl-home').value,
                away: document.getElementById('pl-away').value,
                location: document.getElementById('pl-loc').value
            };
            await fetch(`${API_BASE}/schedule/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dbName: db, scheduleData: plan })
            });
            closeModals();
            loadPlanning();
        }

        // --- MATCHES (RESULTS) ---
        async function loadMatches() {
            const db = document.getElementById('match-db').value;
            try {
                const res = await fetch(`${API_BASE}/data/${db}`);
                const data = await res.json();
                const list = data.matches || [];
                renderMatches(list, db);
                // No legacy select update needed
            } catch (e) { console.error(e); }
        }

        function renderMatches(list, db) {
            const grid = document.getElementById('grid-matches');
            grid.innerHTML = '';
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-header">
                        <span class="badge">${item.date}</span>
                        <span class="badge" style="background:#555; color:white">${item.score}</span>
                    </div>
                    <h3>${item.home} vs ${item.away}</h3>
                    <p style="color:#aaa; font-size:0.8rem">${item.sets || ''}</p>
                    <div class="actions">
                        <div class="icon-action" onclick='editMatch(${JSON.stringify(item)})'><i class="fa-solid fa-pen"></i></div>
                        <div class="icon-action del" onclick="deleteItem('${db}', '${item.id}')"><i class="fa-solid fa-trash"></i></div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function editMatch(item = null) {
            document.getElementById('modal-match').style.display = 'flex';
            if (item) {
                document.getElementById('mt-id').value = item.id;
                document.getElementById('mt-date').value = item.date;
                document.getElementById('mt-score').value = item.score;
                document.getElementById('mt-home').value = item.home;
                document.getElementById('mt-away').value = item.away;
                document.getElementById('mt-sets').value = item.sets || '';
            } else {
                document.getElementById('mt-id').value = Date.now().toString();
                document.getElementById('mt-date').value = '';
                document.getElementById('mt-score').value = '';
                document.getElementById('mt-home').value = 'AS DARDILLY';
                document.getElementById('mt-away').value = '';
                document.getElementById('mt-sets').value = '';
            }
        }

        // Save Basic Match (Also calls API to save core details)
        async function saveMatch() {
            const db = document.getElementById('match-db').value;
            const match = {
                id: document.getElementById('mt-id').value,
                date: document.getElementById('mt-date').value,
                score: document.getElementById('mt-score').value,
                home: document.getElementById('mt-home').value,
                away: document.getElementById('mt-away').value,
                sets: document.getElementById('mt-sets').value
            };
            await fetch(`${API_BASE}/matches/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ dbName: db, matchData: match })
            });
            closeModals();
            loadMatches();
        }


        // --- ADVANCED MATCH DETAILS ---

        async function switchToAdvancedDetail() {
            // Get ID from the currently open basic modal
            const matchId = document.getElementById('mt-id').value;

            // Close basic modal
            closeModals();

            // Load full details for this match
            try {
                // First ensure we have the match data (basic or full)
                const res = await fetch(`${API_BASE}/match/${matchId}`);
                if (!res.ok) {
                    // Match might not exist yet if we are creating new
                    const basicData = {
                        id: matchId,
                        home: document.getElementById('mt-home').value,
                        away: document.getElementById('mt-away').value,
                        score: document.getElementById('mt-score').value,
                        sets: document.getElementById('mt-sets').value
                    };
                    openAdvancedModal(basicData);
                } else {
                    const matchData = await res.json();
                    openAdvancedModal(matchData);
                }
            } catch (e) {
                console.error("Error loading detail", e);
            }
        }

        async function openAdvancedModal(match) {
            document.getElementById('modal-match-detail').style.display = 'flex';

            document.getElementById('adv-id').value = match.id;
            document.getElementById('adv-title').textContent = `${match.home} vs ${match.away}`;
            document.getElementById('adv-score').value = match.score || '';
            document.getElementById('adv-sets').value = match.sets || '';

            // Lineup
            const lu = match.lineup || {};
            document.getElementById('adv-p1').value = lu.p1 || '';
            document.getElementById('adv-p2').value = lu.p2 || '';
            document.getElementById('adv-p3').value = lu.p3 || '';
            document.getElementById('adv-p4').value = lu.p4 || '';
            document.getElementById('adv-p5').value = lu.p5 || '';
            document.getElementById('adv-p6').value = lu.p6 || '';
            document.getElementById('adv-libero').value = lu.libero || '';

            // Render Rosters
            const roster = match.roster || {};
            renderRosterAdmin('list-roster-home', roster.home || []);
            renderRosterAdmin('list-roster-away', roster.away || []);

            // Render Stats
            const tbody = document.getElementById('adv-stats-body');
            tbody.innerHTML = '';
            const stats = match.statsHome || []; // Defaulting to editing HOME team stats for now
            stats.forEach(s => addStatsRowUI(s));

            // Load Player Dropdown for the current team context
            const matchDb = document.getElementById('match-db').value;
            let playerDb = matchDb.replace('matches-', 'db-');

            // Fix for M18 Garcons inconsistent naming
            if (matchDb === 'matches-db') {
                playerDb = 'db-m18-garcons';
            }

            await loadPlayerDropdown(playerDb);
        }

        async function loadPlayerDropdown(dbName) {
            // Populate BOTH the Stats dropdown AND the Home Roster dropdown
            const selects = [document.getElementById('adv-player-select'), document.getElementById('adv-roster-home-select')];
            // Only clear if they exist (roster select might not be in DOM yet if I haven't added HTML, but I will do HTML next)
            // Ideally HTML first. But this function is at bottom.
            // I will update HTML first in next step actually.
            if (document.getElementById('adv-roster-home-select')) {
                selects.forEach(s => s.innerHTML = '<option value="">-- Sélectionner --</option>');
            } else {
                document.getElementById('adv-player-select').innerHTML = '<option value="">-- Sélectionner --</option>';
            }

            try {
                const res = await fetch(`${API_BASE}/data/${dbName}`);
                const data = await res.json();
                const players = data.players || [];
                players.sort((a, b) => a.number - b.number);

                players.forEach(p => {
                    const optContent = `#${p.number} - ${p.name}`;
                    const optVal = p.number;

                    const targetSelects = document.getElementById('adv-roster-home-select') ? selects : [document.getElementById('adv-player-select')];

                    targetSelects.forEach(s => {
                        const opt = document.createElement('option');
                        opt.value = optVal;
                        opt.textContent = optContent;
                        opt.dataset.name = p.name;
                        s.appendChild(opt);
                    });
                });
            } catch (e) {
                console.log("Could not load players for dropdown", e);
            }
        }

        function addPlayerToStats() {
            const select = document.getElementById('adv-player-select');
            const val = select.value;
            if (!val) return;

            const name = select.selectedOptions[0].dataset.name;
            const rowData = { num: val, name: name, pts: 0, att: 0, blk: 0, ace: 0 };
            addStatsRowUI(rowData);
            select.value = ""; // Reset
        }

        function addStatsRowUI(data) {
            const tbody = document.getElementById('adv-stats-body');
            const tr = document.createElement('tr');
            tr.innerHTML = `
                <td><input type="text" class="st-num" value="${data.num}" style="width:40px; background:#111; color:#fff; border:1px solid #444; text-align:center;" readonly></td>
                <td><input type="text" class="st-name" value="${data.name}" style="width:100%; background:#111; color:#fff; border:1px solid #444;"></td>
                <td><input type="number" class="st-pts" value="${data.pts || 0}" style="width:50px; background:#111; color:#fff; border:1px solid #444;"></td>
                <td><input type="number" class="st-att" value="${data.att || 0}" style="width:50px; background:#111; color:#fff; border:1px solid #444;"></td>
                <td><input type="number" class="st-blk" value="${data.blk || 0}" style="width:50px; background:#111; color:#fff; border:1px solid #444;"></td>
                <td><input type="number" class="st-ace" value="${data.ace || 0}" style="width:50px; background:#111; color:#fff; border:1px solid #444;"></td>
                <td><i class="fa-solid fa-trash" style="color:#ff4e45; cursor:pointer;" onclick="this.parentElement.parentElement.remove()"></i></td>
            `;
            tbody.appendChild(tr);
        }

        // --- ROSTER LOGIC ---

        function renderRosterAdmin(listId, roster) {
            const list = document.getElementById(listId);
            list.innerHTML = '';
            if (!roster) return;
            roster.forEach(item => {
                const li = document.createElement('li');
                li.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:#0f0f0f; padding:8px; margin-bottom:5px; border-radius:4px;";
                li.innerHTML = `
                    <span style="font-size:0.9rem;"><b>#${item.number}</b> ${item.name}</span>
                    <i class="fa-solid fa-xmark" style="color:#ff4e45; cursor:pointer;" onclick="this.parentElement.remove()"></i>
                    <input type="hidden" class="roster-item" data-num="${item.number}" data-name="${item.name}">
                `;
                list.appendChild(li);
            });
        }

        function addHomeRoster() {
            const select = document.getElementById('adv-roster-home-select');
            const val = select.value;
            if (!val) return;
            const name = select.selectedOptions[0].dataset.name;

            // Check if already exists
            const existing = document.querySelectorAll('#list-roster-home .roster-item');
            for (let el of existing) {
                if (el.dataset.num == val) return; // duplicate check
            }

            const list = document.getElementById('list-roster-home');
            const li = document.createElement('li');
            li.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:#0f0f0f; padding:8px; margin-bottom:5px; border-radius:4px;";
            li.innerHTML = `
                <span style="font-size:0.9rem;"><b>#${val}</b> ${name}</span>
                <i class="fa-solid fa-xmark" style="color:#ff4e45; cursor:pointer;" onclick="this.parentElement.remove()"></i>
                <input type="hidden" class="roster-item" data-num="${val}" data-name="${name}">
            `;
            list.appendChild(li);
            select.value = "";
        }

        function addAwayRoster() {
            const numInput = document.getElementById('adv-away-num');
            const nameInput = document.getElementById('adv-away-name');
            const num = numInput.value;
            const name = nameInput.value;

            if (!num || !name) return;

            // Check if already exists
            const existing = document.querySelectorAll('#list-roster-away .roster-item');
            for (let el of existing) {
                if (el.dataset.num == num) return;
            }

            const list = document.getElementById('list-roster-away');
            const li = document.createElement('li');
            li.style.cssText = "display:flex; justify-content:space-between; align-items:center; background:#0f0f0f; padding:8px; margin-bottom:5px; border-radius:4px;";
            li.innerHTML = `
                <span style="font-size:0.9rem;"><b>#${num}</b> ${name}</span>
                <i class="fa-solid fa-xmark" style="color:#ff4e45; cursor:pointer;" onclick="this.parentElement.remove()"></i>
                <input type="hidden" class="roster-item" data-num="${num}" data-name="${name}">
            `;
            list.appendChild(li);
            numInput.value = "";
            nameInput.value = "";
        }

        // --- STATS LOGIC ---
        async function saveAdvancedDetails() {
            const matchId = document.getElementById('adv-id').value;

            // Lineup
            const lineup = {
                p1: document.getElementById('adv-p1').value,
                p2: document.getElementById('adv-p2').value,
                p3: document.getElementById('adv-p3').value,
                p4: document.getElementById('adv-p4').value,
                p5: document.getElementById('adv-p5').value,
                p6: document.getElementById('adv-p6').value,
                libero: document.getElementById('adv-libero').value,
            };

            // Stats Home
            const rows = document.querySelectorAll('#adv-stats-body tr');
            const statsHome = Array.from(rows).map(tr => ({
                num: tr.querySelector('.st-num').value,
                name: tr.querySelector('.st-name').value,
                pts: parseInt(tr.querySelector('.st-pts').value) || 0,
                att: parseInt(tr.querySelector('.st-att').value) || 0,
                blk: parseInt(tr.querySelector('.st-blk').value) || 0,
                ace: parseInt(tr.querySelector('.st-ace').value) || 0,
            }));

            // Rosters
            const rosterHomeItems = document.querySelectorAll('#list-roster-home .roster-item');
            const rosterHome = Array.from(rosterHomeItems).map(el => ({
                number: el.dataset.num,
                name: el.dataset.name
            }));

            const rosterAwayItems = document.querySelectorAll('#list-roster-away .roster-item');
            const rosterAway = Array.from(rosterAwayItems).map(el => ({
                number: el.dataset.num,
                name: el.dataset.name
            }));

            const setsInput = document.getElementById('adv-sets').value;
            const setsArray = setsInput ? setsInput.split(',').map(s => s.trim()).filter(s => s.length > 0) : [];

            const payload = {
                score: document.getElementById('adv-score').value,
                sets: setsArray,
                lineup: lineup,
                statsHome: statsHome, // Legacy
                stats: {
                    home: statsHome,
                    away: []
                },
                roster: {
                    home: rosterHome,
                    away: rosterAway
                }
            };

            await fetch(`${API_BASE}/match/${matchId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });

            alert("Détails du match enregistrés !");
            closeModals();
            loadMatches(); // Refresh grid
        }

        // --- PLAYERS ---
        async function loadPlayers() {
            const db = document.getElementById('player-db').value;
            try {
                const res = await fetch(`${API_BASE}/data/${db}`);
                const data = await res.json();
                renderPlayers(data.players || [], db);
            } catch (e) { console.error(e); }
        }

        function renderPlayers(list, db) {
            const grid = document.getElementById('grid-players');
            grid.innerHTML = '';
            list.forEach(item => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                    <div class="card-header">
                        <span class="badge">#${item.number}</span>
                        <span style="font-weight:bold">${item.pos}</span>
                    </div>
                    <h3>${item.name}</h3>
                    <p style="color:#aaa; font-size:0.9rem">${item.captain ? 'Capitaine' : ''}</p>
                    <div class="actions">
                        <div class="icon-action" onclick='editPlayer(${JSON.stringify(item)})'><i class="fa-solid fa-pen"></i></div>
                        <div class="icon-action del" onclick="deleteItem('${db}', '${item.number}')"><i class="fa-solid fa-trash"></i></div>
                    </div>
                `;
                grid.appendChild(div);
            });
        }

        function editPlayer(item = null) {
            document.getElementById('modal-player').style.display = 'flex';
            if (item) {
                document.getElementById('py-number').value = item.number;
                document.getElementById('py-name').value = item.name;
                document.getElementById('py-pos').value = item.pos || item.position;
                document.getElementById('py-profile').value = item.profile || '';
                document.getElementById('py-captain').checked = !!item.captain;

                // Bio
                document.getElementById('py-nat').value = item.nationality || '';
                document.getElementById('py-age').value = item.age || '';
                document.getElementById('py-dob').value = item.dob || '';
                document.getElementById('py-height').value = item.height || '';

                // Stats
                const s = item.stats || {};
                document.getElementById('st-total').value = s.totalPoints || 0;
                document.getElementById('st-avg-m').value = s.avgPerMatch || 0;

                const att = s.attack || {};
                document.getElementById('st-att-pts').value = att.points || 0;
                document.getElementById('st-att-eff').value = att.eff || '';
                document.getElementById('st-att-avg').value = att.avg || 0;

                const blk = s.block || {};
                document.getElementById('st-blk-pts').value = blk.points || 0;
                document.getElementById('st-blk-succ').value = blk.succ || '';
                document.getElementById('st-blk-avg').value = blk.avg || 0;

                const srv = s.serve || {};
                document.getElementById('st-srv-pts').value = srv.points || 0;
                document.getElementById('st-srv-succ').value = srv.succ || '';
                document.getElementById('st-srv-avg').value = srv.avg || 0;
            } else {
                document.getElementById('py-number').value = '';
                document.getElementById('py-name').value = '';
                document.getElementById('py-pos').value = 'OH';
                document.getElementById('py-profile').value = '';
                document.getElementById('py-captain').checked = false;

                // Reset Bio
                document.getElementById('py-nat').value = '';
                document.getElementById('py-age').value = '';
                document.getElementById('py-dob').value = '';
                document.getElementById('py-height').value = '';

                // Reset Stats
                document.getElementById('st-total').value = 0;
                document.getElementById('st-avg-m').value = 0;
                document.getElementById('st-att-pts').value = 0;
                document.getElementById('st-att-eff').value = '';
                document.getElementById('st-att-avg').value = 0;
                document.getElementById('st-blk-pts').value = 0;
                document.getElementById('st-blk-succ').value = '';
                document.getElementById('st-blk-avg').value = 0;
                document.getElementById('st-srv-pts').value = 0;
                document.getElementById('st-srv-succ').value = '';
                document.getElementById('st-srv-avg').value = 0;
            }
        }

        async function savePlayer() {
            const db = document.getElementById('player-db').value;
            const player = {
                number: parseInt(document.getElementById('py-number').value),
                name: document.getElementById('py-name').value,
                pos: document.getElementById('py-pos').value,
                position: document.getElementById('py-pos').value, // Dual support
                profile: document.getElementById('py-profile').value,
                captain: document.getElementById('py-captain').checked,
                nationality: document.getElementById('py-nat').value,
                age: parseInt(document.getElementById('py-age').value) || 0,
                dob: document.getElementById('py-dob').value,
                height: document.getElementById('py-height').value,
                stats: {
                    totalPoints: parseInt(document.getElementById('st-total').value) || 0,
                    avgPerMatch: parseFloat(document.getElementById('st-avg-m').value) || 0,
                    attack: {
                        points: parseInt(document.getElementById('st-att-pts').value) || 0,
                        eff: document.getElementById('st-att-eff').value,
                        avg: parseFloat(document.getElementById('st-att-avg').value) || 0
                    },
                    block: {
                        points: parseInt(document.getElementById('st-blk-pts').value) || 0,
                        succ: document.getElementById('st-blk-succ').value,
                        avg: parseFloat(document.getElementById('st-blk-avg').value) || 0
                    },
                    serve: {
                        points: parseInt(document.getElementById('st-srv-pts').value) || 0,
                        succ: document.getElementById('st-srv-succ').value,
                        avg: parseFloat(document.getElementById('st-srv-avg').value) || 0
                    }
                }
            };
            await fetch(`${API_BASE}/players/update`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ team: db, playerInfo: player })
            });
            closeModals();
            loadPlayers();
        }

        // Init
        window.addEventListener('DOMContentLoaded', () => {
            loadPlanning();
        });

    </script>
</body>

</html>